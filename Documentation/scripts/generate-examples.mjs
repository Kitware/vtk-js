import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const SOURCES_ROOT = path.resolve(__dirname, '../../Sources/');
const EXAMPLES_ROOT = path.resolve(__dirname, '../../Examples/');
const OUTPUT_FOLDER = path.join(__dirname, '../examples/');
const EXAMPLES_BASE_URL = process.env.EXAMPLES_BASE_URL || '';

const EXAMPLE_SOURCES = [
  {
    root: SOURCES_ROOT,
    baseSegment: 'Sources',
    shouldSkipDir: (relDir) =>
      relDir === 'Testing' || relDir.startsWith('Testing/'),
    isExampleFile: (relPath) => /\/example\/index\.js$/.test(relPath),
    getExampleName: (fullPath) =>
      path.basename(path.dirname(path.dirname(fullPath))),
  },
  {
    root: EXAMPLES_ROOT,
    baseSegment: 'Examples',
    shouldSkipDir: () => false,
    isExampleFile: (relPath) => {
      const segments = relPath.split('/');
      return segments.length === 3 && segments[2] === 'index.js';
    },
    getExampleName: (fullPath) => path.basename(path.dirname(fullPath)),
  },
];

function buildExampleUrl(baseSegment, relPath) {
  const normalizedPath = path.posix.join(
    baseSegment,
    relPath.replace(/\\/g, '/')
  );
  if (!EXAMPLES_BASE_URL) {
    return normalizedPath;
  }
  return `${EXAMPLES_BASE_URL.replace(/\/$/, '')}/${normalizedPath}`;
}

async function walkExamples(config, dir = config.root, results = []) {
  const entries = await fs.readdir(dir, { withFileTypes: true });
  await Promise.all(
    entries.map(async (entry) => {
      const fullPath = path.join(dir, entry.name);
      if (entry.isDirectory()) {
        const relDir = path.relative(config.root, fullPath).replace(/\\/g, '/');
        // console.log('Visiting directory:', relDir);
        if (relDir && config.shouldSkipDir(relDir)) {
          return;
        }
        await walkExamples(config, fullPath, results);
      } else if (entry.name === 'index.js') {
        const relPath = path
          .relative(config.root, fullPath)
          .replace(/\\/g, '/');
        if (!config.isExampleFile(relPath)) return;
        const exampleUrl = buildExampleUrl(config.baseSegment, relPath);
        const exampleName = config.getExampleName(fullPath, relPath);
        // Link convention
        const link = `./examples/${exampleName}.html`;
        results.push({
          title: exampleName,
          link,
          exampleUrl,
        });
      }
    })
  );
  return results;
}

function buildExampleMarkdown(name) {
  const examplePage = `${name}/index.html`;
  return `---
layout: page
sidebar: false
title: ${name}
---

<!-- This file is auto-generated by scripts/generate-examples.mjs -->
<ClientOnly>
  <div style="height: calc(100vh - 154px);">
    <iframe
      src="${examplePage}"
      title="${name} example"
      loading="lazy"
      style="width: 100%; height: 500px; border: none;"
      allowfullscreen
    ></iframe>
  </div>
</ClientOnly>
`;
}

async function removeStaleMarkdownFiles(validNames) {
  const entries = await fs.readdir(OUTPUT_FOLDER, { withFileTypes: true });
  await Promise.all(
    entries
      .filter(
        (entry) =>
          entry.isFile() &&
          entry.name.endsWith('.md') &&
          entry.name !== 'index.md' &&
          !validNames.has(path.basename(entry.name, '.md'))
      )
      .map((entry) => fs.unlink(path.join(OUTPUT_FOLDER, entry.name)))
  );
}

async function removeStaleExampleDirs(validNames) {
  const entries = await fs.readdir(OUTPUT_FOLDER, { withFileTypes: true });
  await Promise.all(
    entries
      .filter(
        (entry) =>
          entry.isDirectory() &&
          !entry.name.startsWith('_') &&
          !validNames.has(entry.name)
      )
      .map((entry) =>
        fs.rm(path.join(OUTPUT_FOLDER, entry.name), {
          recursive: true,
          force: true,
        })
      )
  );
}

async function writeMarkdownFiles(examples) {
  await fs.mkdir(OUTPUT_FOLDER, { recursive: true });
  const validNames = new Set(examples.map((ex) => ex.title));
  await removeStaleMarkdownFiles(validNames);
  await removeStaleExampleDirs(validNames);

  await Promise.all(
    examples.map(async ({ title, exampleUrl }) => {
      const mdContent = buildExampleMarkdown(title);
      const mdPath = path.join(OUTPUT_FOLDER, `${title}.md`);
      await fs.writeFile(mdPath, mdContent, 'utf-8');
    })
  );
}

async function main() {
  const examplesByRoot = await Promise.all(
    EXAMPLE_SOURCES.map((config) => walkExamples(config))
  );
  const examples = examplesByRoot.flat();
  examples.sort((a, b) => a.title.localeCompare(b.title));
  await writeMarkdownFiles(examples);
  console.log(
    `Generated ${examples.length} example markdown files in ${OUTPUT_FOLDER}.`
  );
}

main();
